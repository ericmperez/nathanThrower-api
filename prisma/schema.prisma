generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Nullable for OAuth users
  name      String
  firstName String?
  lastName  String?
  age       Int?
  language  String?  @default("en") // en, es
  role          String   @default("user") // user, admin, nathan, dad, coach, player
  goals         String[] @default([]) // Training goals: velo, command, injury_prevention, mechanics, endurance
  endGoal       String?  // Long-term goal: play_college, go_pro, improve_for_fun, make_team, stay_healthy
  currentVelocity Int?   // Current velocity in MPH
  targetVelocity  Int?   // One-year target velocity in MPH
  profilePicture String?  // URL to profile picture in cloud storage
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Authentication & Security fields
  emailVerified           Boolean?  @default(false)
  emailVerificationToken  String?
  emailVerificationExpiry DateTime?
  passwordResetToken      String?
  passwordResetExpiry     DateTime?
  failedLoginAttempts     Int       @default(0)
  lockedUntil             DateTime?

  // OAuth fields
  oauthProvider String?  // 'apple', 'google', null for email/password
  oauthId       String?  // Provider's user ID (e.g., Apple sub, Google sub)
  
  @@index([oauthProvider, oauthId])

  // Push notification tokens
  pushTokens PushToken[]

  analyses      Analysis[]
  purchases     Purchase[]
  refreshTokens RefreshToken[]
  subscription  Subscription?
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  
  // Referral relations
  referralCode    ReferralCode?  // User's own referral code
  referralsMade   Referral[]     @relation("ReferralsMade") // People this user referred
  referredBy      Referral?      @relation("ReferredBy")    // Who referred this user

  // Pitch counting
  pitchCountSessions PitchCountSession[]

  // Audit logs
  authAuditLogs AuthAuditLog[]

  // Workout & Streaks
  workoutLogs WorkoutLog[]
  streak      UserStreak?

  // Training Programs
  programEnrollments UserProgramEnrollment[]

  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
}

model Subscription {
  id              String    @id @default(cuid())
  userId          String    @unique
  tier            String    @default("free") // free, premium, pro, elite
  plan            String    // weekly, quarterly, monthly, yearly
  status          String    @default("active") // active, cancelled, expired
  provider        String    // stripe, apple, google, mock
  providerSubId   String?   // External subscription ID
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean  @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([tier])
  @@index([currentPeriodEnd])
}

model PushToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // ExponentPushToken[...]
  deviceId  String?  // Optional device identifier
  platform  String   @default("ios") // ios, android
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  content    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  // Video attachment fields (optional)
  videoUrl   String?  // Public URL for video
  videoKey   String?  // S3 key for video
  hasVideo   Boolean  @default(false)

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, createdAt])
  @@index([receiverId, createdAt])
  @@index([receiverId, isRead])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  deviceId  String?  // Optional device identifier
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model VideoAsset {
  id           String   @id @default(cuid())
  key          String   @unique
  url          String
  thumbnailUrl String?
  filename     String
  sizeBytes    Int
  duration     Int? // seconds
  createdAt    DateTime @default(now())

  analysis Analysis?

  @@index([key])
}

model Analysis {
  id            String   @id @default(cuid())
  userId        String
  videoAssetId  String   @unique
  pitchType     String // FB, CB, CH, SL
  handedness    String // R, L
  goal          String // velo, command, injury_prevention
  status        String   @default("queued") // queued, processing, completed, failed
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  videoAsset VideoAsset  @relation(fields: [videoAssetId], references: [id], onDelete: Cascade)
  metrics    AnalysisMetrics?
  report     CoachingReport?

  @@index([userId, createdAt])
  @@index([status])
}

model AnalysisMetrics {
  id         String   @id @default(cuid())
  analysisId String   @unique
  data       Json // stores the metrics object
  createdAt  DateTime @default(now())

  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
}

model CoachingReport {
  id         String   @id @default(cuid())
  analysisId String   @unique
  data       Json // stores the full coaching report
  createdAt  DateTime @default(now())

  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
}

model Course {
  id           String   @id @default(cuid())
  title        String
  description  String   @db.Text
  thumbnailUrl String?
  price        Int // cents
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lessons   Lesson[]
  purchases Purchase[]

  @@index([isPublished])
}

model Lesson {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String   @db.Text
  videoUrl    String?
  duration    Int // seconds
  order       Int
  isFree      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId, order])
}

model Purchase {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  status     String // pending, completed, refunded
  provider   String // stripe, apple, google, mock
  receiptRef String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Drill {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  videoUrl    String?
  category    String // warmup, mechanics, recovery, etc
  tags        String[] // for searching
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

// ==========================================
// REFERRAL SYSTEM
// ==========================================

model ReferralCode {
  id        String   @id @default(cuid())
  userId    String   @unique
  code      String   @unique // e.g., "NATHAN25" or auto-generated
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([code])
}

model Referral {
  id              String   @id @default(cuid())
  referralCodeId  String   // The code that was used
  referrerId      String   // User who owns the code (the referrer)
  referredId      String   @unique // New user who signed up with the code
  status          String   @default("pending") // pending, active, cancelled
  commissionRate  Float    @default(0.20) // 20% commission
  freeMonthsGiven Int      @default(0) // Months credited to referrer
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  referralCode ReferralCode @relation(fields: [referralCodeId], references: [id])
  referrer     User         @relation("ReferralsMade", fields: [referrerId], references: [id], onDelete: Cascade)
  referred     User         @relation("ReferredBy", fields: [referredId], references: [id], onDelete: Cascade)
  commissions  Commission[]

  @@index([referrerId])
  @@index([status])
}

model Commission {
  id          String    @id @default(cuid())
  referralId  String
  amount      Int       // cents
  currency    String    @default("USD")
  status      String    @default("pending") // pending, approved, paid, rejected
  description String?   // e.g., "Pro Monthly - December 2024"
  paidAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  referral Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@index([status])
}

// ==========================================
// PITCH COUNTER SYSTEM
// ==========================================

model PitchCountSession {
  id          String   @id @default(cuid())
  userId      String
  sessionType String   // "game" or "bullpen"
  age         Int      // Player's age at time of session
  date        DateTime @default(now())
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  pitches PitchCountEntry[]

  @@index([userId, date])
  @@index([userId, createdAt])
}

model PitchCountEntry {
  id        String   @id @default(cuid())
  sessionId String
  pitchType String   // "fastball", "curveball", "slider", "changeup", etc.
  result    String   // "strike", "ball", "foul", "hit", "out"
  order     Int      // Order in the session
  createdAt DateTime @default(now())

  session PitchCountSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, order])
}

model PitchCountLimit {
  id              String   @id @default(cuid())
  minAge          Int      // Minimum age for this limit
  maxAge          Int      // Maximum age for this limit (inclusive)
  sessionType     String   // "game" or "bullpen"
  maxPitches      Int      // Maximum pitches allowed
  warningThreshold Int     // Alert when approaching (e.g., 80% of max)
  restDaysAfter   Int      // Rest days required after reaching max
  isActive        Boolean  @default(true)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([minAge, maxAge, sessionType])
  @@index([isActive])
}

model RestDayGuideline {
  id            String   @id @default(cuid())
  minAge        Int      // Minimum age for this guideline
  maxAge        Int      // Maximum age for this guideline (inclusive)
  pitchCountMin Int      // Minimum pitch count for this guideline
  pitchCountMax Int?     // Maximum pitch count (null means unlimited)
  restDays      Int      // Rest days required
  isActive      Boolean  @default(true)
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([minAge, maxAge])
  @@index([isActive])
}

// ==========================================
// WORKOUT ACTIVITY & STREAKS
// ==========================================

model WorkoutLog {
  id          String   @id @default(cuid())
  userId      String
  courseId    String?  // Optional - can be null for general activity
  lessonId    String?  // Optional - specific lesson completed
  activityType String  // "lesson_complete", "course_complete", "drill", "pitch_session"
  date        DateTime @default(now()) // The date of the activity
  duration    Int?     // Duration in seconds (optional)
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, courseId, lessonId, activityType]) // Prevent duplicate logs for same activity
  @@index([userId, date])
  @@index([userId, createdAt])
}

model UserStreak {
  id              String   @id @default(cuid())
  userId          String   @unique
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActivityDate DateTime?
  streakStartDate DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==========================================
// AUTHENTICATION AUDIT LOG
// ==========================================

model AuthAuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // login, logout, password_change, password_reset, email_verification, failed_login, account_locked
  ipAddress String?
  userAgent String?
  metadata  Json?    // Additional context (deviceId, etc.)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
}

// ==========================================
// TRAINING PROGRAMS
// ==========================================

model TrainingProgram {
  id            String   @id @default(cuid())
  title         String
  description   String   @db.Text
  category      String   // velocity, mechanics, injury_prevention, endurance
  difficulty    String   // beginner, intermediate, advanced
  durationWeeks Int      @default(4)
  thumbnailUrl  String?
  isActive      Boolean  @default(true)
  isPremium     Boolean  @default(true) // Requires Premium+ subscription
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  weeks       TrainingProgramWeek[]
  enrollments UserProgramEnrollment[]

  @@index([category])
  @@index([isActive])
  @@index([isPremium])
}

model TrainingProgramWeek {
  id          String   @id @default(cuid())
  programId   String
  weekNumber  Int
  title       String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  program TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  days    TrainingProgramDay[]

  @@unique([programId, weekNumber])
  @@index([programId])
}

model TrainingProgramDay {
  id        String   @id @default(cuid())
  weekId    String
  dayNumber Int      // 1-7
  title     String
  drillIds  String[] // Array of Drill IDs
  notes     String?  @db.Text
  restDay   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  week TrainingProgramWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@unique([weekId, dayNumber])
  @@index([weekId])
}

model UserProgramEnrollment {
  id            String   @id @default(cuid())
  userId        String
  programId     String
  startDate     DateTime @default(now())
  currentWeek   Int      @default(1)
  currentDay    Int      @default(1)
  status        String   @default("active") // active, completed, paused, cancelled
  completedDays String[] // Array of completed day IDs
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  program TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId, status])
  @@index([programId])
}

// ==========================================
// CONTENT (TIP OF THE WEEK, etc.)
// ==========================================

model TipOfTheWeek {
  id           String    @id @default(cuid())
  title        String
  description  String?   @db.Text
  videoUrl     String    // URL to video on CDN
  thumbnailUrl String?   // Optional thumbnail image
  publishedAt  DateTime  @default(now())
  expiresAt    DateTime? // Optional expiration date
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([isActive, publishedAt])
  @@index([expiresAt])
}
